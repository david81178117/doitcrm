# 聊天数据更新流程说明

## 背景

用户消息查询系统 (http://101.200.135.82:5006/) 读取的是 **v2.wecom_chat_logs** 表，而企业微信数据导入到的是 **public.wecom_chat_logs** 表。

因此，更新数据需要两个步骤：
1. 从 JSONL 文件导入到 `public.wecom_chat_logs`
2. 同步数据到 `v2.wecom_chat_logs`

## 数据流程图

```
企业微信原始数据
    ↓
/opt/wecom/decrypted_database_ready.jsonl (解密后的JSONL)
    ↓
[步骤1] python3 wecom_etl.py (ETL导入)
    ↓
public.wecom_chat_logs (旧schema)
    ↓
[步骤2] sync_chat_logs.sql (增量同步)
    ↓
v2.wecom_chat_logs (新schema)
    ↓
用户消息查询系统 http://101.200.135.82:5006/
```

## 方法一：使用自动化脚本（推荐）

### 一键更新
```bash
cd /root/doitcrm
./update_chat_data.sh
```

### 自定义参数
```bash
# 指定JSONL文件路径
./update_chat_data.sh --jsonl /path/to/your/file.jsonl

# 修改冲突策略（skip=跳过 | update=更新）
./update_chat_data.sh --conflict skip
```

### 脚本功能
- ✅ 自动检查文件是否存在
- ✅ 导入JSONL数据到 public.wecom_chat_logs
- ✅ 自动同步到 v2.wecom_chat_logs
- ✅ 显示详细进度和结果
- ✅ 错误自动退出

## 方法二：手动执行两步

### 步骤1：导入JSONL数据
```bash
export DATABASE_URL="postgresql://postgres:doit123@localhost/wechat_db"
python3 /root/wechatdata/scripts/wecom_etl.py \
    --jsonl "/opt/wecom/decrypted_database_ready.jsonl" \
    --conflict update
```

**参数说明：**
- `--jsonl`: JSONL文件路径
- `--conflict skip`: 如果msgid已存在，跳过
- `--conflict update`: 如果msgid已存在，更新记录

### 步骤2：同步到v2 schema
```bash
psql -U postgres -d wechat_db -f /root/doitcrm/db/sync_chat_logs.sql
```

**或者用单行命令：**
```bash
PGPASSWORD=doit123 psql -U postgres -d wechat_db -f /root/doitcrm/db/sync_chat_logs.sql
```

## 验证数据

### 检查记录数量
```bash
psql -U postgres -d wechat_db -c "
SELECT
    'public.wecom_chat_logs' as table_name,
    COUNT(*) as record_count
FROM public.wecom_chat_logs
UNION ALL
SELECT
    'v2.wecom_chat_logs' as table_name,
    COUNT(*) as record_count
FROM v2.wecom_chat_logs;
"
```

### 检查最新消息时间
```bash
psql -U postgres -d wechat_db -c "
SELECT
    'public' as schema_name,
    MAX(msgtime) as latest_message_time,
    COUNT(*) as total_count
FROM public.wecom_chat_logs
UNION ALL
SELECT
    'v2' as schema_name,
    MAX(msgtime) as latest_message_time,
    COUNT(*) as total_count
FROM v2.wecom_chat_logs;
"
```

## 常见问题

### Q1: 执行完ETL脚本后，网页看不到新数据？
**A:** 需要执行步骤2，将数据同步到 v2.wecom_chat_logs。或者直接使用 `update_chat_data.sh` 自动化脚本。

### Q2: conflict 参数选 skip 还是 update？
**A:**
- `skip`: 只插入新消息，已有msgid的消息保持不变（推荐日常使用）
- `update`: 更新已有消息，适合修复数据错误的场景

### Q3: 同步脚本会删除现有数据吗？
**A:** 不会。`sync_chat_logs.sql` 使用 `ON CONFLICT DO NOTHING` 策略，只插入新消息，不会删除或修改已有数据。

### Q4: 多久需要更新一次数据？
**A:** 取决于企业微信数据拉取频率。每次生成新的 `decrypted_database_ready.jsonl` 后，运行更新脚本即可。

## 文件位置

- 自动化脚本: `/root/doitcrm/update_chat_data.sh`
- 同步SQL: `/root/doitcrm/db/sync_chat_logs.sql`
- ETL脚本: `/root/wechatdata/scripts/wecom_etl.py`
- JSONL数据: `/opt/wecom/decrypted_database_ready.jsonl`

## 相关服务

- 用户消息查询: http://101.200.135.82:5006/
- ID映射管理: http://101.200.135.82:5004/
- 班级花名册: http://101.200.135.82:5010/
