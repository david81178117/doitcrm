# 企业微信群组API权限问题说明

## ⚠️ 当前问题

调用客户群API时返回错误：

```
errcode: 60011
errmsg: no privilege to access/modify contact/party/agent
```

## 🔍 问题分析

### 错误码含义
- **60011**: 没有权限访问/修改通讯录/部门/应用

### 根本原因
当前使用的 **Secret** 对应的应用**没有足够的权限**访问客户群信息。

## 📋 需要的权限

要获取客户群信息，需要在企业微信后台配置以下权限：

### 1. 客户联系权限
应用必须具备以下权限：
- ✅ **管理客户** (必需)
- ✅ **管理客户群及客户群成员** (必需)
- ✅ **客户联系人的"可见范围"** (必需)

### 2. 应用类型要求
- 必须使用 **"客户联系"应用** 的Secret
- 或者使用有客户联系权限的 **自建应用**

## 🔧 解决方案

### 方案1: 使用客户联系应用的Secret (推荐)

#### 步骤：
1. **登录企业微信管理后台**
   - 访问: https://work.weixin.qq.com/

2. **进入客户联系应用**
   - 左侧菜单 → **应用管理**
   - 找到 **"客户联系"** 应用

3. **获取Secret**
   - 点击进入 **"客户联系"** 应用
   - 找到 **Secret** (可能显示为"客户联系Secret"或"通讯录同步Secret")
   - 点击 **"查看"** 或 **"重置Secret"**

4. **配置权限**
   - 确认该应用有以下权限勾选：
     - ☑️ 管理企业客户
     - ☑️ 管理客户群
     - ☑️ 管理企业成员

5. **更新代码配置**
   ```python
   WECOM_CONFIG = {
       'corp_id': 'ww3036e4989a99bb2d',
       'secret': '新的客户联系Secret',  # 使用客户联系应用的Secret
   }
   ```

6. **配置IP白名单**
   - 在 **"客户联系"** 应用中
   - 找到 **"企业可信IP"** 配置
   - 添加当前IP: 38.60.206.109 (本地Mac) 或 172.182.200.132 (Codespaces)

### 方案2: 使用自建应用并配置权限

#### 步骤：
1. **创建自建应用**
   - 应用管理 → 自建 → 创建应用

2. **配置应用权限**
   - 在应用详情中，找到 **"接口权限"**
   - 开启以下权限：
     - ☑️ 客户联系 → 管理客户
     - ☑️ 客户联系 → 管理客户群及客户群成员
     - ☑️ 通讯录管理 → 成员信息读取

3. **配置可见范围**
   - 在应用详情中，设置 **"可见范围"**
   - 添加需要使用该应用的成员

4. **获取并使用Secret**
   - 复制应用的Secret
   - 更新代码配置

5. **配置IP白名单**
   - 在应用详情中配置 **"企业可信IP"**

### 方案3: 使用不同的API获取群信息 (临时方案)

如果无法获取客户群权限，可以考虑：

1. **仅获取内部群** (不含外部客户)
   - 使用通讯录管理权限
   - API: `/cgi-bin/appchat/get`

2. **手动维护群组名称**
   - 不使用API自动获取
   - 在界面上手动填写群组名称

## 📝 权限检查清单

在企业微信后台检查以下项目：

- [ ] 使用的Secret类型：
  - [ ] 客户联系应用Secret
  - [ ] 自建应用Secret (需配置权限)
  - [ ] 其他应用Secret (可能不支持)

- [ ] 应用权限配置：
  - [ ] 管理客户
  - [ ] 管理客户群及客户群成员
  - [ ] 成员信息读取

- [ ] 可见范围：
  - [ ] 已添加需要使用的成员

- [ ] IP白名单：
  - [ ] 已添加当前服务器IP

## 🔗 相关API文档

### 1. 获取客户群列表
**接口**: `/cgi-bin/externalcontact/groupchat/list`
**权限**: 客户联系 - 管理客户群

### 2. 获取客户群详情
**接口**: `/cgi-bin/externalcontact/groupchat/get`
**权限**: 客户联系 - 管理客户群

### 3. 获取外部联系人
**接口**: `/cgi-bin/externalcontact/get`
**权限**: 客户联系 - 管理客户

## 🎯 测试步骤

配置完成后，按以下步骤测试：

### 1. 测试access_token获取
```bash
curl "https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=ww3036e4989a99bb2d&corpsecret=新的Secret"
```

应返回：
```json
{
  "errcode": 0,
  "errmsg": "ok",
  "access_token": "xxx",
  "expires_in": 7200
}
```

### 2. 测试权限
```bash
# 获取客户群列表
curl -X POST "https://qyapi.weixin.qq.com/cgi-bin/externalcontact/groupchat/list?access_token=你的token" \
  -H "Content-Type: application/json" \
  -d '{
    "status_filter": 0,
    "offset": 0,
    "limit": 10
  }'
```

如果返回 `errcode: 0`，说明权限配置成功。

### 3. 运行测试程序
```bash
python3 test_batch_rooms.py
# 选择选项1测试单个群组
```

## 📞 常见问题

### Q1: 如何确认当前Secret的权限？
**A**:
1. 登录企业微信后台
2. 找到对应的应用
3. 查看"接口权限"或"API权限"列表

### Q2: 能否同时使用多个Secret？
**A**:
可以！不同的Secret用于不同的功能：
- 客户联系Secret → 获取外部联系人、客户群
- 通讯录同步Secret → 获取内部成员
- 自建应用Secret → 根据配置的权限使用

### Q3: 如果企业没有开通"客户联系"功能怎么办？
**A**:
1. 需要先在企业微信后台开通"客户联系"功能
2. 或者联系企业微信管理员开通
3. 部分基础版可能不支持，需升级

### Q4: 权限配置后多久生效？
**A**:
通常立即生效，建议等待1-2分钟后再测试

## 🔄 下一步

完成权限配置后：

1. **更新配置文件**
   - 修改 `wecom_id_mapper.py` 中的Secret
   - 或使用环境变量: `export WECOM_SECRET="新Secret"`

2. **重启服务**
   ```bash
   # 停止现有服务
   # 重新启动
   python3 wecom_id_mapper.py
   ```

3. **测试功能**
   ```bash
   python3 test_batch_rooms.py
   ```

4. **批量获取群组**
   - 选择选项3或4
   - 等待处理完成

---

**重要提示**: 请妥善保管Secret，不要泄露给他人。建议使用环境变量而不是硬编码。

**最后更新**: 2025-12-31
