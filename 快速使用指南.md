# 🚀 快速使用指南

## ✅ 当前状态

- **本地Mac IP**: 38.60.206.109 ✅ 已配置并测试通过
- **企业微信API**: ✅ 连接正常
- **数据库**: ✅ 连接正常

## 📦 项目包含的工具

### 1️⃣ 企业微信ID映射系统 (wecom_id_mapper.py)
**端口**: 5004
**功能**:
- 🔍 查看和管理所有企业微信ID映射
- 🤖 **自动从企业微信API获取真实姓名**
- ✏️ 手动编辑映射关系
- 📊 统计映射进度

**启动方式**:
```bash
python3 wecom_id_mapper.py
# 访问: http://localhost:5004
```

**主要操作**:
1. 点击 "测试API连接" - 确认企业微信API可用
2. 点击 "批量获取昵称" - 自动填充用户/群聊名称
3. 手动编辑未能自动获取的名称

---

### 2️⃣ 用户消息查询系统 (user_messages.py)
**端口**: 5005
**功能**:
- 🔍 按用户名搜索聊天记录
- 📅 指定时间范围查询
- 💬 查看群聊和私聊消息
- 🤖 **AI智能总结聊天内容**

**启动方式**:
```bash
python3 user_messages.py
# 访问: http://localhost:5005
```

**主要操作**:
1. 输入用户姓名搜索
2. 选择时间范围
3. 查看所有对话记录
4. 点击 "智能总结" 按钮 - AI自动分析

---

### 3️⃣ 家长沟通分析系统 (parent_analyzer.py)
**功能**:
- 📊 深度分析家长聊天记录
- 🏷️ 自动生成客户标签
- 😊 情绪态度分析
- 📝 生成完整分析报告

**启动方式**:
```bash
python3 parent_analyzer.py
# 交互式选择用户进行分析
```

---

## 🎯 快速启动 (推荐)

使用快速启动脚本:

```bash
./quick_start.sh
```

然后选择:
- 选项1: 启动企业微信ID映射 (推荐先做这个)
- 选项2: 启动用户消息查询
- 选项3: 启动家长沟通分析
- 选项4: 同时启动1+2

## 📋 典型使用流程

### 场景1: 批量导入企业微信数据

```bash
# 1. 启动ID映射服务
python3 wecom_id_mapper.py

# 2. 访问 http://localhost:5004
# 3. 点击 "初始化映射表"
# 4. 点击 "提取所有ID"
# 5. 点击 "测试API连接" (确认IP白名单已配置)
# 6. 点击 "批量获取昵称" - 选择用户,限制50个
# 7. 等待完成,重复步骤6直到所有用户处理完
# 8. 对群聊重复步骤6
```

### 场景2: 查询某个用户的聊天记录

```bash
# 1. 启动用户消息查询服务
python3 user_messages.py

# 2. 访问 http://localhost:5005
# 3. 输入用户姓名 (如: 张三)
# 4. 选择时间范围 (默认30天)
# 5. 查看所有聊天记录
# 6. 点击 "智能总结" 查看AI分析
```

### 场景3: 分析家长沟通情况

```bash
# 1. 运行分析工具
python3 parent_analyzer.py

# 2. 从列表中选择要分析的家长
# 3. 查看完整的分析报告
# 4. 分析结果自动保存到数据库
```

## ⚠️ 重要提示

### IP白名单管理

**本地Mac使用** (当前配置):
- IP: **38.60.206.109** ✅
- 如果API突然失败,检查IP是否变化:
  ```bash
  curl https://api.ipify.org
  ```
- 如果IP变化,需要在企业微信后台更新

**GitHub Codespaces使用**:
- ❌ 不要在Codespaces中调用企业微信API
- ✅ 可以在Codespaces中开发代码
- ✅ 在本地Mac或阿里云服务器上运行服务

**生产环境** (推荐):
- 使用阿里云ECS固定IP
- 配置一次即可长期使用

### 数据库连接

当前配置:
```python
DB_CONFIG = {
    'host': 'localhost',      # 如在远程服务器,修改为实际地址
    'database': 'wechat_db',
    'user': 'postgres',
    'password': 'doit123',
    'port': '5432'
}
```

如果在本地Mac运行,需要:
1. 安装PostgreSQL或连接远程数据库
2. 修改`DB_CONFIG`中的`host`为阿里云数据库地址
3. 确保网络可以访问阿里云数据库

## 🔧 常见问题

### Q1: 启动服务时提示端口被占用?

```bash
# 查找占用端口的进程
lsof -i :5004
lsof -i :5005

# 停止进程
kill -9 <PID>
```

### Q2: 企业微信API返回60020错误?

**原因**: IP白名单未配置或IP变化

**解决**:
1. 获取当前IP: `curl https://api.ipify.org`
2. 登录企业微信管理后台
3. 添加/更新IP白名单

### Q3: 数据库连接失败?

**检查**:
1. 数据库服务是否启动
2. 用户名密码是否正确
3. 防火墙/安全组是否开放端口
4. 如使用阿里云RDS,检查白名单配置

### Q4: 批量获取名称失败?

**可能原因**:
1. ID已被删除 (员工离职/客户删除)
2. Secret权限不足
3. API调用频率过快

**建议**:
- 分批处理,每批50个
- 查看日志了解详细错误

## 📊 数据统计参考

当前数据量 (2025-12-31):
- 用户: 1130 (未映射: 1128)
- 群聊: 121 (未映射: 121)

预计批量处理时间:
- 每批50个,约5-10秒
- 全部用户: 约5-10分钟
- 全部群聊: 约2-3分钟

## 🔗 更多文档

- [企业微信API配置记录](./企业微信API配置记录.md) - 详细配置信息
- [企业微信IP白名单配置](./企业微信IP白名单配置.md) - IP配置指南
- [README_WECOM_API](./README_WECOM_API.md) - API详细文档
- [README_PARENT_ANALYZER](./README_PARENT_ANALYZER.md) - 家长分析工具说明

## 💡 下一步建议

1. ✅ **先完成ID映射** - 批量获取所有用户和群聊名称
2. ✅ **测试消息查询** - 查询几个用户验证功能
3. ✅ **试用AI分析** - 分析1-2个家长的沟通情况
4. 📝 **部署到生产** - 配置阿里云服务器IP,正式上线

---

**有问题?** 检查日志或查看详细文档!
