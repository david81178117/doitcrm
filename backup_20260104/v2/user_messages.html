<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·æ¶ˆæ¯æŸ¥è¯¢ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            margin-bottom: 20px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-content > div:first-child {
            text-align: left;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .version-input-container {
            flex-shrink: 0;
        }

        .version-input {
            width: 120px;
            padding: 8px 12px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .version-input::placeholder {
            color: rgba(255,255,255,0.7);
        }

        .version-input:focus {
            outline: none;
            border-color: white;
            background: rgba(255,255,255,0.3);
        }

        /* æŸ¥è¯¢è¡¨å•æ ·å¼ */
        .query-form {
            padding: 30px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
        }

        .form-row-single {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .form-row-single .form-group {
            flex: 1;
            min-width: 0;
        }

        .form-row-single .form-group:last-child {
            flex: 0 0 auto;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group-wide {
            flex: 2;
        }

        .form-group label {
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group select {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .compact-select {
            min-width: 120px;
        }

        .multi-select {
            position: relative;
        }

        .multi-select-trigger {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: #fff;
            text-align: left;
            font-size: 14px;
            cursor: pointer;
        }

        .multi-select-panel {
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            padding: 12px;
            z-index: 50;
            max-height: 320px;
            overflow-y: auto;
        }

        .multi-select-panel.hidden {
            display: none;
        }

        .multi-select-search {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .multi-select-actions {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
            color: #666;
        }

        .multi-select-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 240px;
            overflow-y: auto;
        }

        .multi-select-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            border-radius: 6px;
            cursor: pointer;
        }

        .multi-select-item:hover {
            background: #f5f5f5;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #666;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #e0e0e0;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ç”¨æˆ·é€‰æ‹©åŒºåŸŸæ ·å¼ */
        .user-selection {
            padding: 20px 30px;
            background: #fff3cd;
            border-bottom: 1px solid #ffd700;
        }

        .user-selection-header {
            font-size: 14px;
            color: #856404;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .user-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .user-item {
            padding: 15px 20px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-item:hover {
            border-color: #667eea;
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .user-item-main {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .user-item-name {
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }

        .user-item-role {
            font-size: 14px;
            color: #666;
        }

        .user-item-id {
            font-size: 12px;
            color: #999;
            font-family: 'Courier New', monospace;
        }

        /* å·²é€‰ç”¨æˆ·ä¿¡æ¯ */
        .selected-user-info {
            padding: 15px 30px;
            background: #e3f2fd;
            border-bottom: 1px solid #90caf9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .selected-user-details {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .selected-user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }

        .selected-user-text {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .selected-user-name {
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }

        .selected-user-meta {
            font-size: 12px;
            color: #666;
        }

        /* æ¶ˆæ¯å®¹å™¨æ ·å¼ */
        .messages-container {
            padding: 30px;
            min-height: 400px;
        }

        /* 3åˆ—ç½‘æ ¼å¸ƒå±€ */
        #messages-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .empty-state-text {
            font-size: 16px;
        }

        .loading-state {
            text-align: center;
            padding: 60px 20px;
            color: #667eea;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* å¯¹è¯å¡ç‰‡æ ·å¼ */
        .conversation-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
            transition: all 0.3s;
        }

        .conversation-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .group-conversation {
            border-left: 4px solid #7b1fa2;
        }

        .private-conversation {
            border-left: 4px solid #1976d2;
        }

        .conversation-header {
            padding: 20px;
            background: #fafafa;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .conversation-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .conversation-icon {
            font-size: 24px;
        }

        .conversation-title h3 {
            font-size: 18px;
            font-weight: 500;
            color: #333;
        }

        .badge {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .conversation-meta {
            font-size: 13px;
            color: #666;
        }

        .messages-list {
            padding: 15px 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        /* ç¾åŒ–æ»šåŠ¨æ¡ */
        .messages-list::-webkit-scrollbar {
            width: 8px;
        }

        .messages-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .messages-list::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .messages-list::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .message-item {
            display: grid;
            grid-template-columns: 140px 60px 1fr;
            gap: 10px;
            padding: 12px;
            border-bottom: 1px solid #f5f5f5;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .message-item:last-child {
            border-bottom: none;
        }

        /* å‘é€çš„æ¶ˆæ¯ */
        .message-sent {
            background: #e3f2fd;
            border-left: 3px solid #2196f3;
        }

        /* æ¥æ”¶çš„æ¶ˆæ¯ */
        .message-received {
            background: #f5f5f5;
            border-left: 3px solid #9e9e9e;
        }

        .message-time {
            font-size: 12px;
            color: #999;
            font-family: 'Courier New', monospace;
        }

        .message-sender {
            font-size: 12px;
            font-weight: 500;
            color: #666;
        }

        .message-content {
            font-size: 14px;
            color: #333;
            line-height: 1.6;
            word-break: break-word;
        }

        /* å­¦å‘˜ä¿¡æ¯æ ·å¼ */
        .student-info-section {
            margin-top: 20px;
            background: #f9fafb;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e0e0e0;
        }

        .student-info-header {
            margin-bottom: 15px;
        }

        .student-info-header h4 {
            margin: 0;
            color: #333;
            font-size: 16px;
        }

        .student-info-fields {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 15px;
            align-items: end;
        }

        .student-field {
            display: flex;
            flex-direction: column;
        }

        .student-field label {
            font-size: 13px;
            color: #666;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .student-field input {
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .student-field input:focus {
            outline: none;
            border-color: #667eea;
        }

        .student-field-actions {
            display: flex;
            align-items: flex-end;
        }

        /* Toasté€šçŸ¥ */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4caf50;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
        }

        .toast.error {
            background: #f44336;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(400px); opacity: 0; }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            #messages-container {
                grid-template-columns: repeat(2, 1fr);
            }

            .form-row-single {
                flex-wrap: wrap;
            }

            .student-info-fields {
                grid-template-columns: 1fr 1fr;
            }

            .student-field-actions {
                grid-column: 1 / -1;
            }
        }

        @media (max-width: 768px) {
            .student-info-fields {
                grid-template-columns: 1fr;
            }
            #messages-container {
                grid-template-columns: 1fr;
            }

            .form-row-single {
                flex-direction: column;
                align-items: stretch;
            }

            .message-item {
                grid-template-columns: 1fr;
            }

            .conversation-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }

        /* AIæ€»ç»“åŒºåŸŸæ ·å¼ */
        .ai-summary-section {
            margin-top: 20px;
            background: linear-gradient(135deg, #f0f7ff 0%, #e8f4ff 100%);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #4a90e2;
            box-shadow: 0 2px 8px rgba(74, 144, 226, 0.1);
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #d0e7ff;
        }

        .summary-header h4 {
            margin: 0;
            color: #2c5aa0;
            font-size: 16px;
            font-weight: 600;
        }

        .summary-meta {
            font-size: 12px;
            color: #666;
            background: white;
            padding: 4px 10px;
            border-radius: 12px;
        }

        .summary-content {
            font-size: 14px;
            line-height: 1.8;
            color: #333;
            white-space: pre-wrap;
            word-break: break-word;
            background: white;
            padding: 16px;
            border-radius: 8px;
            max-height: 500px;
            overflow-y: auto;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .summary-loading {
            text-align: center;
            padding: 40px;
            color: #4a90e2;
        }

        .summary-loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .summary-error {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            color: #856404;
        }

        #ai-summary-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #ai-summary-spinner {
            margin-left: 5px;
            animation: spin 1s linear infinite;
        }

        .multi-users-section {
            padding: 20px 30px;
            border-bottom: 1px solid #e0e0e0;
            max-height: 320px;
            overflow-y: auto;
            background: #fffdfa;
        }

        .multi-users-section.hidden {
            display: none;
        }

        .multi-users-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .multi-user-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 10px;
        }

        .multi-user-item {
            padding: 10px 12px;
            background: #f9fafb;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            gap: 10px;
        }

        .multi-user-item.selected {
            border-color: #667eea;
            background: #e3f2fd;
        }

        .multi-user-item:hover {
            border-color: #667eea;
        }

        .multi-user-meta {
            font-size: 12px;
            color: #666;
        }

        .multi-messages-section {
            padding: 20px 30px 30px;
            background: #fff;
            display: none;
        }

        .multi-messages-content {
            background: #f9fafb;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            min-height: 260px;
            max-height: 520px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }

        .multi-analysis-section {
            margin-top: 16px;
            background: linear-gradient(135deg, #f0f7ff 0%, #e8f4ff 100%);
            border-radius: 12px;
            padding: 18px;
            border: 2px solid #4a90e2;
            display: none;
        }

        .multi-analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #d0e7ff;
        }

        .multi-analysis-content {
            background: white;
            padding: 14px;
            border-radius: 8px;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 500px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡µé¢å¤´éƒ¨ -->
        <div class="header">
            <div class="header-content">
                <div>
                    <h1>ğŸ“¨ ç”¨æˆ·æ¶ˆæ¯æŸ¥è¯¢ç³»ç»Ÿ</h1>
                    <p>æŸ¥è¯¢ä¼ä¸šå¾®ä¿¡ç”¨æˆ·æ¶ˆæ¯ï¼ŒæŒ‰å¯¹è¯åˆ†ç»„å±•ç¤º</p>
                </div>
                <div class="version-input-container">
                    <input type="text" id="version-input" placeholder="ç‰ˆæœ¬" class="version-input" autocomplete="off" />
                </div>
            </div>
        </div>

        <!-- æŸ¥è¯¢è¡¨å• -->
        <div class="query-form">
            <div class="form-row-single">
                <div class="form-group form-group-wide">
                    <label for="user-name-input">ç”¨æˆ· / å­¦å‘˜ / ID</label>
                    <input
                        type="text"
                        id="user-name-input"
                        placeholder="æ”¯æŒç”¨æˆ·å§“åã€å­¦å‘˜å§“åã€ç”¨æˆ·ID"
                        autocomplete="off"
                    />
                </div>
                <div class="form-group">
                    <label for="section-select">æ®µ</label>
                    <select id="section-select" class="compact-select">
                        <option value="">å…¨éƒ¨</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="level-select">é˜¶</label>
                    <select id="level-select" class="compact-select">
                        <option value="">å…¨éƒ¨</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="class-select">ç­çº§</label>
                    <div class="multi-select" id="class-select">
                        <button type="button" class="multi-select-trigger" id="class-trigger">å…¨éƒ¨</button>
                        <div class="multi-select-panel hidden" id="class-panel">
                            <input type="text" class="multi-select-search" id="class-search" placeholder="æœç´¢ç­çº§/roomid">
                            <div class="multi-select-actions">
                                <span id="class-count">å¯é€‰ 0</span>
                                <button type="button" class="btn btn-secondary" onclick="clearClassSelection()">æ¸…ç©º</button>
                            </div>
                            <div class="multi-select-list" id="class-list"></div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="start-time-input">å¼€å§‹æ—¶é—´</label>
                    <input type="datetime-local" id="start-time-input" />
                </div>
                <div class="form-group">
                    <label for="end-time-input">ç»“æŸæ—¶é—´</label>
                    <input type="datetime-local" id="end-time-input" />
                </div>
                <div class="form-group">
                    <button class="btn btn-secondary" onclick="resetTimeRange()">é‡ç½®ä¸ºé»˜è®¤ï¼ˆ30å¤©ï¼‰</button>
                </div>
                <div class="form-group">
                    <button class="btn btn-primary" onclick="applyMultiFilters()">æŸ¥è¯¢</button>
                </div>
            </div>
        </div>

        <div id="multi-users-section" class="multi-users-section hidden">
            <div class="multi-users-header">
                <div>ç­›é€‰ç»“æœ (<span id="multi-user-count">0</span>äºº)</div>
                <div>
                    <label><input type="checkbox" id="multi-select-all" onchange="toggleMultiSelectAll()"> å…¨é€‰</label>
                </div>
            </div>
            <div id="multi-user-list" class="multi-user-list"></div>
        </div>

        <div class="multi-messages-section">
            <div class="messages-header">
                èŠå¤©è®°å½•æ±‡æ€»
                <button class="btn btn-secondary" id="multi-aggregate-btn" onclick="viewMultiMessages()" disabled style="margin-left: 20px;">æ±‡æ€»å†…å®¹</button>
                <button class="btn btn-primary" id="multi-analysis-btn" onclick="runMultiAnalysis()" disabled style="margin-left: 10px;">æ™ºèƒ½æ€»ç»“</button>
            </div>
            <div id="multi-messages-content" class="multi-messages-content">
                <div class="empty-state">
                    <div style="font-size: 48px; margin-bottom: 15px;">ğŸ’¬</div>
                    <div style="font-size: 16px;">è¯·å…ˆç­›é€‰ç”¨æˆ·å¹¶æŸ¥çœ‹èŠå¤©è®°å½•</div>
                </div>
            </div>
            <div id="multi-analysis-section" class="multi-analysis-section">
                <div class="multi-analysis-header">
                    <h4>ğŸ¤– AIæ™ºèƒ½æ€»ç»“</h4>
                    <span class="analysis-meta" id="multi-analysis-meta"></span>
                </div>
                <div class="multi-analysis-content" id="multi-analysis-content"></div>
            </div>
        </div>

        <!-- ç”¨æˆ·é€‰æ‹©åŒºåŸŸï¼ˆåŒåå¤„ç†ï¼‰-->
        <div id="user-selection-area" style="display: none;">
            <div class="user-selection">
                <div class="user-selection-header" id="user-selection-header">
                    å‘ç°å¤šä¸ªåŒ¹é…ç”¨æˆ·ï¼Œè¯·é€‰æ‹©ï¼š
                </div>
                <div class="user-list" id="user-list"></div>
            </div>
        </div>

        <!-- å·²é€‰ç”¨æˆ·ä¿¡æ¯ -->
        <div id="selected-user-info" style="display: none;">
            <div class="selected-user-info">
                <div class="selected-user-details">
                    <div class="selected-user-avatar" id="user-avatar">ğŸ‘¤</div>
                    <div class="selected-user-text">
                        <div class="selected-user-name" id="user-display-name">å¼ ä¸‰</div>
                        <div class="selected-user-meta">
                            <span id="user-role-text">å®¶é•¿</span> Â·
                            <span id="user-id-text">wmqDzZEw...</span>
                        </div>
                    </div>
                </div>
                <div>
                    <button class="btn btn-primary btn-sm" id="ai-summary-btn" onclick="handleAISummary()">
                        <span id="ai-summary-text">æ™ºèƒ½æ€»ç»“</span>
                        <span id="ai-summary-spinner" style="display:none;">â³</span>
                    </button>
                </div>
            </div>

            <!-- å­¦å‘˜ä¿¡æ¯è¾“å…¥åŒºåŸŸï¼ˆä»…å®¶é•¿è§’è‰²æ˜¾ç¤ºï¼‰ -->
            <div class="student-info-section" id="student-info-section" style="display: none;">
                <div class="student-info-header">
                    <h4>ğŸ‘¨â€ğŸ“ å­¦å‘˜ä¿¡æ¯</h4>
                </div>
                <div class="student-info-fields">
                    <div class="student-field">
                        <label for="student-name-input">å­¦å‘˜å§“å</label>
                        <input type="text" id="student-name-input" placeholder="è¯·è¾“å…¥å­¦å‘˜å§“å" />
                    </div>
                    <div class="student-field">
                        <label for="student-english-name-input">å­¦å‘˜è‹±æ–‡å</label>
                        <input type="text" id="student-english-name-input" placeholder="è¯·è¾“å…¥è‹±æ–‡å" />
                    </div>
                    <div class="student-field">
                        <label for="student-class-room-id-input">åœ¨è¯»ç­çº§ (Room ID)</label>
                        <input type="text" id="student-class-room-id-input" placeholder="è¯·è¾“å…¥ç­çº§Room ID" />
                    </div>
                    <div class="student-field-actions">
                        <button class="btn btn-primary btn-sm" onclick="saveStudentInfo()">ä¿å­˜å­¦å‘˜ä¿¡æ¯</button>
                    </div>
                </div>
            </div>

            <!-- AIæ€»ç»“ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
            <div class="ai-summary-section" id="ai-summary-section" style="display: none;">
                <div class="summary-header">
                    <h4>ğŸ¤– AIæ™ºèƒ½æ€»ç»“</h4>
                    <span class="summary-meta" id="summary-meta"></span>
                </div>
                <div class="summary-content" id="summary-content"></div>
            </div>
        </div>

        <!-- æ¶ˆæ¯å±•ç¤ºåŒºåŸŸ -->
        <div class="messages-container">
            <div class="empty-state" id="empty-state">
                <div class="empty-state-icon">ğŸ”</div>
                <div class="empty-state-text">è¯·è¾“å…¥å…³é”®è¯å¼€å§‹æŸ¥è¯¢</div>
            </div>

            <div class="loading-state" id="loading-state" style="display: none;">
                <div class="loading-spinner"></div>
                <div>æ­£åœ¨åŠ è½½æ¶ˆæ¯...</div>
            </div>

            <div id="messages-container"></div>
        </div>
    </div>

    <script>
        const API_BASE = '';
        let selectedUser = null;
        let isTeacherMode = false;
        let searchTimeout = null;
        let multiUsers = [];
        let selectedUserIds = [];
        let aggregatedText = '';
        let aggregatedMeta = { total_users: 0, total_messages: 0 };
        let hierarchyOptions = { sections: [], levels: [], classes: [] };
        let selectedClassIds = [];

        window.onload = () => {
            resetTimeRange();
            loadFilterOptions();
            setupEventListeners();
        };

        function setupEventListeners() {
            const nameInput = document.getElementById('user-name-input');
            const versionInput = document.getElementById('version-input');
            const sectionSelect = document.getElementById('section-select');
            const levelSelect = document.getElementById('level-select');
            const classTrigger = document.getElementById('class-trigger');
            const classPanel = document.getElementById('class-panel');
            const classSearch = document.getElementById('class-search');

            versionInput.addEventListener('input', function() {
                const value = this.value.trim();
                if (value === '111') {
                    isTeacherMode = true;
                    showToast('å·²åˆ‡æ¢åˆ°è€å¸ˆæ¨¡å¼', false);
                    this.value = '';
                    const name = nameInput.value.trim();
                    if (name.length >= 1) {
                        searchUsers(name, 'teacher');
                    }
                }
            });

            nameInput.addEventListener('input', function() {
                const name = this.value.trim();
                clearTimeout(searchTimeout);

                if (name.length >= 1) {
                    searchTimeout = setTimeout(() => {
                        const role = isTeacherMode ? 'teacher' : 'parent';
                        searchUsers(name, role);
                    }, 300);
                } else {
                    hideUserSelection();
                }
            });

            sectionSelect.addEventListener('change', () => {
                updateLevelOptions();
                updateClassList();
                markFiltersDirty();
            });

            levelSelect.addEventListener('change', () => {
                updateClassList();
                markFiltersDirty();
            });

            classTrigger.addEventListener('click', (event) => {
                event.preventDefault();
                classPanel.classList.toggle('hidden');
                classSearch.focus();
            });

            classSearch.addEventListener('input', () => {
                updateClassList();
            });

            document.addEventListener('click', (event) => {
                if (!document.getElementById('class-select').contains(event.target)) {
                    classPanel.classList.add('hidden');
                }
            });
        }

        function resetTimeRange() {
            const endTime = new Date();
            const startTime = new Date(endTime - 30 * 24 * 60 * 60 * 1000);

            document.getElementById('end-time-input').value = formatDatetimeLocal(endTime);
            document.getElementById('start-time-input').value = formatDatetimeLocal(startTime);
        }

        function formatDatetimeLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        async function searchUsers(name, role) {
            try {
                const url = `/api/search-users?keyword=${encodeURIComponent(name)}&role=${role}`;
                const response = await fetch(url);
                const result = await response.json();

                if (result.status === 'error') {
                    showToast(result.message, true);
                    return;
                }

                if (result.count === 0) {
                    showToast('æœªæ‰¾åˆ°åŒ¹é…çš„ç”¨æˆ·', true);
                    hideUserSelection();
                } else if (result.count === 1) {
                    selectUser(result.users[0]);
                } else {
                    showUserSelection(result.users);
                }
            } catch (error) {
                showToast('æœç´¢å¤±è´¥: ' + error.message, true);
            }
        }

        async function loadFilterOptions() {
            try {
                const response = await fetch('/api/filter-options');
                const result = await response.json();
                if (result.status !== 'success') return;
                const options = result.options || {};
                hierarchyOptions = {
                    sections: options.sections || [],
                    levels: options.levels || [],
                    classes: options.classes || []
                };

                const sectionSelect = document.getElementById('section-select');
                sectionSelect.innerHTML = '<option value="">å…¨éƒ¨</option>';
                hierarchyOptions.sections.forEach(section => {
                    sectionSelect.innerHTML += `<option value="${section.id}">${section.name}</option>`;
                });

                updateLevelOptions();
                updateClassList();

            } catch (error) {
                showToast('åŠ è½½ç­›é€‰é€‰é¡¹å¤±è´¥', true);
            }
        }

        function updateLevelOptions() {
            const sectionId = document.getElementById('section-select').value;
            const levelSelect = document.getElementById('level-select');
            const previousLevel = levelSelect.value;
            levelSelect.innerHTML = '<option value="">å…¨éƒ¨</option>';
            const levels = sectionId
                ? hierarchyOptions.levels.filter(level => String(level.section_id) === String(sectionId))
                : hierarchyOptions.levels;
            levels.forEach(level => {
                levelSelect.innerHTML += `<option value="${level.id}">${level.name}</option>`;
            });
            if (previousLevel && levels.some(level => String(level.id) === String(previousLevel))) {
                levelSelect.value = previousLevel;
            } else {
                levelSelect.value = '';
            }
        }

        function updateClassList() {
            const sectionId = document.getElementById('section-select').value;
            const levelId = document.getElementById('level-select').value;
            const searchValue = document.getElementById('class-search').value.trim().toLowerCase();
            const classList = document.getElementById('class-list');
            const classCount = document.getElementById('class-count');

            let classes = hierarchyOptions.classes.slice();
            if (sectionId) {
                classes = classes.filter(cls => String(cls.section_id) === String(sectionId));
            }
            if (levelId) {
                classes = classes.filter(cls => String(cls.level_id) === String(levelId));
            }
            if (searchValue) {
                classes = classes.filter(cls => {
                    const name = (cls.name || '').toLowerCase();
                    const roomId = (cls.room_id || '').toLowerCase();
                    return name.includes(searchValue) || roomId.includes(searchValue);
                });
            }

            const allowedIds = new Set(classes.map(cls => String(cls.id)));
            selectedClassIds = selectedClassIds.filter(id => allowedIds.has(String(id)));

            classCount.textContent = `å¯é€‰ ${classes.length}`;
            classList.innerHTML = '';
            if (!classes.length) {
                classList.innerHTML = '<div class="multi-select-item">æš‚æ— ç­çº§</div>';
                updateClassTrigger();
                return;
            }

            classes.forEach(cls => {
                const id = String(cls.id);
                const label = cls.name || cls.room_id || `ç­çº§ ${id}`;
                const checked = selectedClassIds.includes(id);
                const item = document.createElement('label');
                item.className = 'multi-select-item';
                item.innerHTML = `
                    <input type="checkbox" value="${id}" ${checked ? 'checked' : ''}>
                    <span>${label}</span>
                `;
                item.querySelector('input').addEventListener('change', (event) => {
                    if (event.target.checked) {
                        if (!selectedClassIds.includes(id)) selectedClassIds.push(id);
                    } else {
                        selectedClassIds = selectedClassIds.filter(val => val !== id);
                    }
                    updateClassTrigger();
                    markFiltersDirty();
                });
                classList.appendChild(item);
            });
            updateClassTrigger();
        }

        function updateClassTrigger() {
            const trigger = document.getElementById('class-trigger');
            if (!selectedClassIds.length) {
                trigger.textContent = 'å…¨éƒ¨';
                return;
            }
            if (selectedClassIds.length === 1) {
                const cls = hierarchyOptions.classes.find(c => String(c.id) === String(selectedClassIds[0]));
                trigger.textContent = cls ? (cls.name || cls.room_id || 'å·²é€‰ 1 ä¸ª') : 'å·²é€‰ 1 ä¸ª';
                return;
            }
            trigger.textContent = `å·²é€‰ ${selectedClassIds.length} ä¸ª`;
        }

        function clearClassSelection() {
            selectedClassIds = [];
            updateClassList();
            markFiltersDirty();
        }

        async function applyMultiFilters() {
            const filters = {
                section_id: document.getElementById('section-select').value,
                level_id: document.getElementById('level-select').value,
                class_ids: selectedClassIds.length ? selectedClassIds : undefined,
                keyword: document.getElementById('user-name-input').value.trim()
            };

            Object.keys(filters).forEach(key => {
                if (!filters[key]) delete filters[key];
            });

            if (!isTeacherMode) {
                filters.role = 'parent';
            } else {
                filters.role = 'teacher';
            }

            try {
                const response = await fetch('/api/filter-users', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({filters})
                });
                const result = await response.json();
                if (result.status !== 'success') {
                    showToast(result.message || 'ç­›é€‰å¤±è´¥', true);
                    return;
                }
                multiUsers = result.users || [];
                selectedUserIds = [];
                aggregatedText = '';
                aggregatedMeta = { total_users: 0, total_messages: 0 };
                const multiMessagesSection = document.querySelector('.multi-messages-section');
                multiMessagesSection.style.display = 'block';
                document.getElementById('multi-messages-content').innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 40px; margin-bottom: 12px;">ğŸ—‚ï¸</div>
                        <div style="font-size: 14px;">è¯·å…ˆå‹¾é€‰ç”¨æˆ·ï¼Œå†ç‚¹å‡»â€œæ±‡æ€»å†…å®¹â€</div>
                    </div>
                `;
                document.getElementById('multi-analysis-section').style.display = 'none';
                document.getElementById('multi-aggregate-btn').disabled = true;
                document.getElementById('multi-analysis-btn').disabled = true;
                renderMultiUsers();
                showToast(`ç­›é€‰æˆåŠŸï¼Œæ‰¾åˆ° ${result.count} ä¸ªç”¨æˆ·`);
            } catch (error) {
                showToast('ç­›é€‰å¤±è´¥: ' + error.message, true);
            }
        }

        function markFiltersDirty() {
            multiUsers = [];
            selectedUserIds = [];
            aggregatedText = '';
            aggregatedMeta = { total_users: 0, total_messages: 0 };
            document.getElementById('multi-users-section').classList.add('hidden');
            document.querySelector('.multi-messages-section').style.display = 'none';
            document.getElementById('multi-aggregate-btn').disabled = true;
            document.getElementById('multi-analysis-btn').disabled = true;
        }

        function renderMultiUsers() {
            const section = document.getElementById('multi-users-section');
            const list = document.getElementById('multi-user-list');
            const count = document.getElementById('multi-user-count');
            const selectAll = document.getElementById('multi-select-all');

            if (!multiUsers.length) {
                section.classList.add('hidden');
                return;
            }

            section.classList.remove('hidden');
            count.textContent = multiUsers.length;
            list.innerHTML = '';
            selectAll.checked = false;

            multiUsers.forEach(user => {
                const item = document.createElement('div');
                item.className = 'multi-user-item';
                item.onclick = (e) => {
                    if (e.target.type !== 'checkbox') {
                        const checkbox = item.querySelector('input[type="checkbox"]');
                        checkbox.checked = !checkbox.checked;
                        toggleMultiUser(user.wechat_id, checkbox.checked);
                    }
                };

                const roleText = user.user_role === 'head_teacher' ? 'ç­ä¸»ä»»' :
                                 user.user_role === 'teacher' ? 'è€å¸ˆ' : 'å®¶é•¿';
                const studentInfo = user.student_name ? `å­¦å‘˜: ${user.student_name}` : 'å­¦å‘˜: æœªå…³è”';
                const messageInfo = `${user.text_message_count || 0}æ¡æ¶ˆæ¯`;

                item.innerHTML = `
                    <input type="checkbox" data-user-id="${user.wechat_id}"
                        onchange="toggleMultiUser('${user.wechat_id}', this.checked)">
                    <div>
                        <div class="user-name">${user.display_name}</div>
                        <div class="multi-user-meta">${roleText} Â· ${studentInfo} Â· ${messageInfo}</div>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function toggleMultiUser(userId, isSelected) {
            if (isSelected) {
                if (!selectedUserIds.includes(userId)) selectedUserIds.push(userId);
            } else {
                selectedUserIds = selectedUserIds.filter(id => id !== userId);
            }

            document.getElementById('multi-aggregate-btn').disabled = selectedUserIds.length === 0;
            document.getElementById('multi-analysis-btn').disabled = true;

            const allCheckboxes = document.querySelectorAll('.multi-user-item input[type="checkbox"]');
            const selectAllCheckbox = document.getElementById('multi-select-all');
            selectAllCheckbox.checked = allCheckboxes.length > 0 &&
                selectedUserIds.length === allCheckboxes.length;

            document.querySelectorAll('.multi-user-item').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox.checked) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        function toggleMultiSelectAll() {
            const isChecked = document.getElementById('multi-select-all').checked;
            const checkboxes = document.querySelectorAll('.multi-user-item input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
                toggleMultiUser(checkbox.getAttribute('data-user-id'), isChecked);
            });
        }

        async function viewMultiMessages() {
            if (!selectedUserIds.length) {
                showToast('è¯·å…ˆé€‰æ‹©ç”¨æˆ·', true);
                return;
            }

            const startTime = document.getElementById('start-time-input').value;
            const endTime = document.getElementById('end-time-input').value;
            const section = document.querySelector('.multi-messages-section');
            const content = document.getElementById('multi-messages-content');

            section.style.display = 'block';
            content.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div><div>æ­£åœ¨åŠ è½½èŠå¤©è®°å½•...</div></div>';

            try {
                const aggregateResponse = await fetch('/api/aggregate-messages', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ user_ids: selectedUserIds, start_time: startTime, end_time: endTime })
                });
                const aggregateResult = await aggregateResponse.json();
                if (aggregateResult.status !== 'success') {
                    content.innerHTML = `<div class="empty-state"><div style="color:#f44336;">${aggregateResult.message}</div></div>`;
                    showToast(aggregateResult.message || 'åŠ è½½å¤±è´¥', true);
                    return;
                }
                aggregatedText = aggregateResult.aggregated_text || '';
                aggregatedMeta = {
                    total_users: aggregateResult.total_users || 0,
                    total_messages: aggregateResult.total_messages || 0
                };
                content.textContent = aggregatedText;
                document.getElementById('multi-analysis-btn').disabled = !aggregatedText;
                showToast(`å·²æ±‡æ€» ${aggregatedMeta.total_users} ä½ç”¨æˆ·ï¼Œå…± ${aggregatedMeta.total_messages} æ¡æ¶ˆæ¯`);
            } catch (error) {
                content.innerHTML = `<div class="empty-state"><div style="color:#f44336;">åŠ è½½å¤±è´¥: ${error.message}</div></div>`;
                showToast('åŠ è½½å¤±è´¥: ' + error.message, true);
            }
        }

        async function runMultiAnalysis() {
            if (!aggregatedText) {
                showToast('è¯·å…ˆç‚¹å‡»â€œæ±‡æ€»å†…å®¹â€', true);
                return;
            }

            const startTime = document.getElementById('start-time-input').value;
            const endTime = document.getElementById('end-time-input').value;
            const section = document.querySelector('.multi-messages-section');
            const analysisSection = document.getElementById('multi-analysis-section');
            const analysisContent = document.getElementById('multi-analysis-content');
            const meta = document.getElementById('multi-analysis-meta');
            const btn = document.getElementById('multi-analysis-btn');

            section.style.display = 'block';
            analysisSection.style.display = 'block';
            analysisContent.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div><div>AIæ­£åœ¨åˆ†æï¼Œè¯·ç¨å€™...</div></div>';
            btn.disabled = true;

            try {
                const response = await fetch('/api/multi-user-analysis', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_ids: selectedUserIds,
                        start_time: startTime,
                        end_time: endTime,
                        aggregated_text: aggregatedText,
                        total_users: aggregatedMeta.total_users,
                        total_messages: aggregatedMeta.total_messages,
                        mode: isTeacherMode ? 'teacher' : 'parent'
                    })
                });
                const result = await response.json();
                if (result.status !== 'success') {
                    analysisContent.innerHTML = `<div style="color:#f44336;">åˆ†æå¤±è´¥: ${result.message}</div>`;
                    showToast(result.message || 'åˆ†æå¤±è´¥', true);
                    return;
                }
                analysisContent.textContent = result.analysis;
                meta.textContent = `${result.user_count}ä½ç”¨æˆ· Â· ${result.message_count}æ¡æ¶ˆæ¯ Â· è€—æ—¶${(result.duration_ms/1000).toFixed(1)}ç§’`;
                showToast(`å·²åˆ†æ ${result.user_count} ä½ç”¨æˆ·`);
            } catch (error) {
                analysisContent.innerHTML = `<div style="color:#f44336;">åˆ†æå¤±è´¥: ${error.message}</div>`;
                showToast('åˆ†æå¤±è´¥: ' + error.message, true);
            } finally {
                btn.disabled = false;
            }
        }

        function resetMultiFilters() {
            document.getElementById('section-select').value = '';
            document.getElementById('level-select').value = '';
            document.getElementById('class-select').value = '';
            document.getElementById('multi-users-section').classList.add('hidden');
            selectedUserIds = [];
            aggregatedText = '';
            aggregatedMeta = { total_users: 0, total_messages: 0 };
            document.getElementById('multi-aggregate-btn').disabled = true;
            document.getElementById('multi-analysis-btn').disabled = true;
        }

        function showUserSelection(users) {
            const area = document.getElementById('user-selection-area');
            const header = document.getElementById('user-selection-header');
            const list = document.getElementById('user-list');

            header.textContent = `å‘ç° ${users.length} ä¸ªåŒ¹é…ç”¨æˆ·ï¼Œè¯·é€‰æ‹©ï¼š`;
            list.innerHTML = '';

            users.forEach(user => {
                const item = document.createElement('div');
                item.className = 'user-item';
                item.onclick = () => selectUser(user);

                let roleText = 'æœªåˆ†ç±»';
                if (user.user_role === 'teacher' || user.user_role === 'head_teacher') {
                    roleText = 'è€å¸ˆ';
                } else if (user.user_role === 'parent') {
                    roleText = 'å®¶é•¿';
                }

                item.innerHTML = `
                    <div class="user-item-main">
                        <div class="user-item-name">${user.display_name}</div>
                        <div class="user-item-role">${roleText}</div>
                        <div class="user-item-id">${user.id_prefix}...</div>
                    </div>
                `;

                list.appendChild(item);
            });

            area.style.display = 'block';
        }

        function hideUserSelection() {
            document.getElementById('user-selection-area').style.display = 'none';
        }

        function selectUser(user) {
            selectedUser = user;
            hideUserSelection();
            showUserInfo(user);
            loadUserMessages();
        }

        function showUserInfo(user) {
            let roleText = 'æœªåˆ†ç±»';
            if (user.user_role === 'teacher' || user.user_role === 'head_teacher') {
                roleText = 'è€å¸ˆ';
            } else if (user.user_role === 'parent') {
                roleText = 'å®¶é•¿';
            }

            const avatar = roleText === 'è€å¸ˆ' ? 'ğŸ‘¨â€ğŸ«' : 'ğŸ‘¤';

            document.getElementById('user-avatar').textContent = avatar;
            document.getElementById('user-display-name').textContent = user.display_name;
            document.getElementById('user-role-text').textContent = roleText;
            document.getElementById('user-id-text').textContent = user.id_prefix + '...';
            document.getElementById('selected-user-info').style.display = 'block';

            if (user.user_role === 'parent') {
                document.getElementById('student-info-section').style.display = 'block';
                document.getElementById('student-name-input').value = user.student_name || '';
                document.getElementById('student-english-name-input').value = user.student_english_name || '';
                document.getElementById('student-class-room-id-input').value = user.student_class_room_id || '';
            } else {
                document.getElementById('student-info-section').style.display = 'none';
            }
        }

        function clearSelection() {
            selectedUser = null;
            document.getElementById('selected-user-info').style.display = 'none';
            document.getElementById('messages-container').innerHTML = '';
            document.getElementById('empty-state').style.display = 'block';
            document.getElementById('user-name-input').value = '';
            document.getElementById('ai-summary-section').style.display = 'none';
        }

        async function loadUserMessages() {
            const container = document.getElementById('messages-container');
            const emptyState = document.getElementById('empty-state');
            const loadingState = document.getElementById('loading-state');

            emptyState.style.display = 'none';
            loadingState.style.display = 'block';
            container.innerHTML = '';

            try {
                const startTime = document.getElementById('start-time-input').value;
                const endTime = document.getElementById('end-time-input').value;

                const url = `/api/user-messages?user_id=${encodeURIComponent(selectedUser.original_id)}&start_time=${startTime}&end_time=${endTime}`;
                const response = await fetch(url);
                const result = await response.json();

                loadingState.style.display = 'none';

                if (result.status === 'error') {
                    showToast(result.message, true);
                    emptyState.style.display = 'block';
                    return;
                }

                if (result.conversation_count === 0) {
                    emptyState.style.display = 'block';
                    emptyState.innerHTML = `
                        <div class="empty-state-icon">ğŸ“­</div>
                        <div class="empty-state-text">è¯¥æ—¶é—´èŒƒå›´å†…æ²¡æœ‰æ‰¾åˆ°æ¶ˆæ¯</div>
                    `;
                } else {
                    const totalMessages = result.conversations.reduce((sum, conv) => sum + conv.message_count, 0);
                    renderConversations(result.conversations);
                }
            } catch (error) {
                loadingState.style.display = 'none';
                showToast('åŠ è½½å¤±è´¥: ' + error.message, true);
                emptyState.style.display = 'block';
            }
        }

        function renderConversations(conversations) {
            const container = document.getElementById('messages-container');
            container.innerHTML = '';

            conversations.forEach((conv, index) => {
                const card = createConversationCard(conv, index);
                container.appendChild(card);
            });
        }

        function createConversationCard(conv) {
            const card = document.createElement('div');
            const isGroup = conv.conversation_type === 'group';
            card.className = `conversation-card ${isGroup ? 'group-conversation' : 'private-conversation'}`;

            const icon = isGroup ? 'ğŸ«' : 'ğŸ‘¤';
            const typeText = isGroup ? 'ç¾¤èŠ' : 'ç§èŠ';

            card.innerHTML = `
                <div class="conversation-header">
                    <div class="conversation-title">
                        <span class="conversation-icon">${icon}</span>
                        <h3>${conv.conversation_name}</h3>
                        <span class="badge">${conv.message_count}æ¡æ¶ˆæ¯</span>
                    </div>
                    <div class="conversation-meta">
                        ${typeText} Â· æœ€åå‘è¨€: ${formatDateTime(conv.last_message_time)}
                    </div>
                </div>
                <div class="messages-list">
                    ${conv.messages.map(msg => createMessageHTML(msg)).join('')}
                </div>
            `;

            return card;
        }

        function createMessageHTML(msg) {
            const directionClass = msg.direction === 'sent' ? 'message-sent' : 'message-received';
            const senderText = msg.direction === 'sent' ? 'æˆ‘' : 'å¯¹æ–¹';

            return `
                <div class="message-item ${directionClass}">
                    <div class="message-time">${formatTime(msg.msgtime)}</div>
                    <div class="message-sender">${senderText}</div>
                    <div class="message-content">${escapeHtml(msg.content)}</div>
                </div>
            `;
        }

        function formatDateTime(isoString) {
            if (!isoString) return '-';
            const date = new Date(isoString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }

        function formatTime(isoString) {
            if (!isoString) return '-';
            const date = new Date(isoString);
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function saveStudentInfo() {
            if (!selectedUser) {
                showToast('è¯·å…ˆé€‰æ‹©ç”¨æˆ·', true);
                return;
            }

            if (selectedUser.user_role !== 'parent') {
                showToast('åªæœ‰å®¶é•¿è§’è‰²æ‰èƒ½ä¿å­˜å­¦å‘˜ä¿¡æ¯', true);
                return;
            }

            const studentName = document.getElementById('student-name-input').value.trim();
            const studentEnglishName = document.getElementById('student-english-name-input').value.trim();
            const studentClassRoomId = document.getElementById('student-class-room-id-input').value.trim();

            try {
                const response = await fetch('/api/update-student-info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: selectedUser.original_id,
                        student_name: studentName,
                        student_english_name: studentEnglishName,
                        student_class_room_id: studentClassRoomId
                    })
                });

                const result = await response.json();

                if (result.status === 'error') {
                    showToast(result.message, true);
                    return;
                }

                selectedUser.student_name = studentName;
                selectedUser.student_english_name = studentEnglishName;
                selectedUser.student_class_room_id = studentClassRoomId;

                showToast('å­¦å‘˜ä¿¡æ¯ä¿å­˜æˆåŠŸ', false);
            } catch (error) {
                showToast('ä¿å­˜å¤±è´¥: ' + error.message, true);
            }
        }

        function showToast(message, isError = false) {
            document.querySelectorAll('.toast').forEach(t => t.remove());

            const toast = document.createElement('div');
            toast.className = 'toast' + (isError ? ' error' : '');
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 2500);
        }

        async function handleAISummary() {
            if (!selectedUser) {
                showToast('è¯·å…ˆé€‰æ‹©ç”¨æˆ·', true);
                return;
            }

            const messagesContainer = document.getElementById('messages-container');
            if (!messagesContainer || messagesContainer.children.length === 0) {
                showToast('æ²¡æœ‰å¯æ€»ç»“çš„æ¶ˆæ¯æ•°æ®', true);
                return;
            }

            const summaryBtn = document.getElementById('ai-summary-btn');
            const summaryText = document.getElementById('ai-summary-text');
            const summarySpinner = document.getElementById('ai-summary-spinner');

            summaryBtn.disabled = true;
            summaryText.textContent = 'æ­£åœ¨æ€»ç»“...';
            summarySpinner.style.display = 'inline';

            const summarySection = document.getElementById('ai-summary-section');
            const summaryContent = document.getElementById('summary-content');
            const summaryMeta = document.getElementById('summary-meta');

            summarySection.style.display = 'block';
            summaryContent.innerHTML = '<div class="summary-loading">AIæ­£åœ¨åˆ†æå¯¹è¯å†…å®¹</div>';

            try {
                const startTime = document.getElementById('start-time-input').value;
                const endTime = document.getElementById('end-time-input').value;

                const response = await fetch('/api/summarize-messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: selectedUser.original_id,
                        user_name: selectedUser.display_name,
                        start_time: startTime,
                        end_time: endTime,
                        mode: isTeacherMode ? 'teacher' : 'parent'
                    })
                });

                const result = await response.json();
                if (result.status === 'error') {
                    throw new Error(result.message);
                }

                summaryContent.textContent = result.summary;
                summaryMeta.textContent = `æ€»ç»“æ—¶é—´: ${formatDateTime(new Date().toISOString())} Â· æ¶ˆæ¯æ•°: ${result.message_count}æ¡ Â· å¯¹è¯æ•°: ${result.conversation_count}ä¸ª`;
                showToast('AIæ€»ç»“å®Œæˆ', false);
            } catch (error) {
                summaryContent.innerHTML = `<div class="summary-error">âŒ æ€»ç»“å¤±è´¥: ${error.message}</div>`;
                showToast('AIæ€»ç»“å¤±è´¥: ' + error.message, true);
            } finally {
                summaryBtn.disabled = false;
                summaryText.textContent = 'æ™ºèƒ½æ€»ç»“';
                summarySpinner.style.display = 'none';
            }
        }
    </script>
</body>
</html>
