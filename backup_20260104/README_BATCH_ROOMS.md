# ä¼ä¸šå¾®ä¿¡å®¢æˆ·ç¾¤æ‰¹é‡è·å–å·¥å…·è¯´æ˜

## ğŸ“‹ åŠŸèƒ½è¯´æ˜

è¿™ä¸ªç‹¬ç«‹ç¨‹åºç”¨äºæ‰¹é‡è·å–ä¼ä¸šå¾®ä¿¡å®¢æˆ·ç¾¤çš„åç§°ï¼Œæ”¯æŒä¸‰ç§è·å–æ–¹å¼ã€‚

## ğŸ”§ è·å–ç¾¤ç»„çš„APIåŸç†

### ä¼ä¸šå¾®ä¿¡APIæ¥å£

**æ¥å£åœ°å€**: `https://qyapi.weixin.qq.com/cgi-bin/externalcontact/groupchat/get`

**è¯·æ±‚æ–¹å¼**: POST

**è¯·æ±‚å‚æ•°**:
```json
{
  "chat_id": "wrqDzZEwAA1pD1sr8s8nP9c_JSVW5j8w",
  "need_name": 1
}
```

**URLå‚æ•°**:
- `access_token`: ä¼ä¸šå¾®ä¿¡access_token

**è¿”å›ç¤ºä¾‹**:
```json
{
  "errcode": 0,
  "errmsg": "ok",
  "group_chat": {
    "chat_id": "wrqDzZEwAA1pD1sr8s8nP9c_JSVW5j8w",
    "name": "å‡¤å‡°30ç­",
    "owner": "YuanGong01",
    "create_time": 1622419332,
    "notice": "ç¾¤å…¬å‘Šå†…å®¹",
    "member_list": [
      {
        "userid": "YuanGong01",
        "type": 1,
        "join_time": 1622419332,
        "join_scene": 1,
        "invitor": {
          "userid": "YuanGong02"
        },
        "group_nickname": "è€å¸ˆ",
        "name": "å¼ è€å¸ˆ"
      },
      {
        "userid": "wmqDzZEwAAxxxx",
        "type": 2,
        "join_time": 1622419456,
        "name": "ç‹å®¶é•¿"
      }
    ],
    "admin_list": [
      {
        "userid": "YuanGong01"
      }
    ]
  }
}
```

### å¸¸è§é”™è¯¯ç 

| é”™è¯¯ç  | è¯´æ˜ | å¤„ç†æ–¹å¼ |
|--------|------|----------|
| 0 | æˆåŠŸ | - |
| 60020 | IPç™½åå•é”™è¯¯ | é…ç½®ä¼ä¸šå¾®ä¿¡åå°IPç™½åå• |
| 86004 | ç¾¤ä¸å­˜åœ¨æˆ–å·²è§£æ•£ | è·³è¿‡è¯¥ç¾¤ |
| 84061 | ç¾¤å·²è¿‡æœŸ | è·³è¿‡è¯¥ç¾¤ |
| 40014 | access_tokenæ— æ•ˆ | é‡æ–°è·å–token |

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### å‰ç½®æ¡ä»¶

1. **å¯åŠ¨æœ¬åœ°æœåŠ¡**
   ```bash
   python3 wecom_id_mapper.py
   ```

2. **ç¡®è®¤IPç™½åå•å·²é…ç½®**
   - å½“å‰é…ç½®çš„IP: 38.60.206.109 (æœ¬åœ°Mac)
   - å¦‚éœ€æ·»åŠ æ–°IPï¼Œè®¿é—®ä¼ä¸šå¾®ä¿¡åå°é…ç½®

### è¿è¡Œæµ‹è¯•ç¨‹åº

```bash
python3 test_batch_rooms.py
```

### é€‰é¡¹è¯´æ˜

ç¨‹åºå¯åŠ¨åä¼šæ˜¾ç¤º4ä¸ªé€‰é¡¹ï¼š

#### é€‰é¡¹1: æµ‹è¯•å•ä¸ªç¾¤ç»„
- **ç”¨é€”**: éªŒè¯ä¼ä¸šå¾®ä¿¡APIæ˜¯å¦å¯ç”¨
- **æ¨è**: é¦–æ¬¡ä½¿ç”¨æ—¶å…ˆè¿è¡Œæ­¤é€‰é¡¹
- **æ“ä½œ**: è·å–ä¸€ä¸ªå·²çŸ¥ç¾¤ç»„IDçš„è¯¦ç»†ä¿¡æ¯

#### é€‰é¡¹2: æ‰¹é‡è·å–50ä¸ªç¾¤ç»„ (ç›´æ¥è°ƒç”¨ä¼ä¸šå¾®ä¿¡API)
- **ç”¨é€”**: æ¼”ç¤ºç›´æ¥è°ƒç”¨ä¼ä¸šå¾®ä¿¡APIçš„æ–¹å¼
- **ç‰¹ç‚¹**:
  - ä»æ•°æ®åº“è¯»å–æœªæ˜ å°„çš„ç¾¤ç»„ID
  - ç›´æ¥è°ƒç”¨ä¼ä¸šå¾®ä¿¡API
  - æ˜¾ç¤ºè¯¦ç»†çš„è°ƒç”¨è¿‡ç¨‹
  - **ä¸ä¼šè‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“**

#### é€‰é¡¹3: æ‰¹é‡è·å–50ä¸ªç¾¤ç»„ (é€šè¿‡æœ¬åœ°API - æ¨è) â­
- **ç”¨é€”**: ç”Ÿäº§ç¯å¢ƒæ¨èä½¿ç”¨
- **ç‰¹ç‚¹**:
  - è°ƒç”¨æœ¬åœ°Flask API
  - **è‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“**
  - æ›´æ–° `is_mapped` æ ‡å¿—
  - æœ‰å®Œæ•´çš„é”™è¯¯å¤„ç†

#### é€‰é¡¹4: æ‰¹é‡è·å–æ‰€æœ‰ç¾¤ç»„
- **ç”¨é€”**: ä¸€æ¬¡æ€§è·å–æ‰€æœ‰æœªæ˜ å°„çš„ç¾¤ç»„
- **æ³¨æ„**:
  - ä¼šæ˜¾ç¤ºå½“å‰æœªæ˜ å°„ç¾¤ç»„æ€»æ•°
  - éœ€è¦ç¡®è®¤æ‰æ‰§è¡Œ
  - è€—æ—¶è¾ƒé•¿ï¼ˆæ¯ä¸ªç¾¤ç»„çº¦0.1ç§’ï¼‰

## ğŸ“ ä»£ç æ ¸å¿ƒé€»è¾‘

### 1. è·å–access_token

```python
def get_access_token():
    url = "https://qyapi.weixin.qq.com/cgi-bin/gettoken"
    params = {
        'corpid': 'ww3036e4989a99bb2d',
        'corpsecret': 'S8UqG5CSPKWQEi7SmJTvPmLKGvRfuWDPQZOzQwdbajU'
    }

    response = requests.get(url, params=params, timeout=10)
    result = response.json()

    if result.get('errcode') == 0:
        return result['access_token']
    else:
        return None
```

### 2. è·å–ç¾¤ç»„è¯¦æƒ…

```python
def get_group_chat_detail(access_token, chat_id):
    url = "https://qyapi.weixin.qq.com/cgi-bin/externalcontact/groupchat/get"
    params = {'access_token': access_token}
    data = {
        'chat_id': chat_id,
        'need_name': 1  # è¿”å›æˆå‘˜åç§°
    }

    response = requests.post(url, params=params, json=data, timeout=10)
    result = response.json()

    if result.get('errcode') == 0:
        group_chat = result.get('group_chat', {})
        return {
            'name': group_chat.get('name', ''),
            'owner': group_chat.get('owner', ''),
            'member_count': len(group_chat.get('member_list', [])),
            # æ›´å¤šå­—æ®µ...
        }
    else:
        return None
```

### 3. æ‰¹é‡å¤„ç†

```python
# ä»æ•°æ®åº“è·å–æœªæ˜ å°„çš„ç¾¤ç»„
unmapped_rooms = [r for r in all_rooms if not r.get('display_name')]

# é€ä¸ªè°ƒç”¨API
for room in unmapped_rooms:
    chat_id = room['original_id']
    group_info = get_group_chat_detail(access_token, chat_id)

    if group_info:
        # æˆåŠŸè·å–
        name = group_info['name']
        # ä¿å­˜åˆ°æ•°æ®åº“...

    # é¿å…APIè°ƒç”¨è¿‡å¿«
    time.sleep(0.1)
```

## ğŸ“Š é¢„æœŸç»“æœ

### å½“å‰æ•°æ®ç»Ÿè®¡
- **ç¾¤ç»„æ€»æ•°**: 123ä¸ª
- **å·²æ˜ å°„**: 0ä¸ª
- **æœªæ˜ å°„**: 123ä¸ª

### æˆåŠŸç‡é¢„ä¼°
- **æ­£å¸¸æˆåŠŸç‡**: 60-80%
- **å¤±è´¥åŸå› **:
  1. ç¾¤å·²è§£æ•£ (errcode: 86004)
  2. ç¾¤å·²è¿‡æœŸ (errcode: 84061)
  3. æƒé™ä¸è¶³
  4. ç½‘ç»œé—®é¢˜

### å¤„ç†æ—¶é—´
- **å•ä¸ªç¾¤ç»„**: çº¦0.1-0.2ç§’
- **50ä¸ªç¾¤ç»„**: çº¦5-10ç§’
- **123ä¸ªç¾¤ç»„**: çº¦12-25ç§’

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. IPç™½åå•
ç¡®ä¿è¿è¡Œç¨‹åºçš„æœºå™¨IPå·²åŠ å…¥ä¼ä¸šå¾®ä¿¡ç™½åå•ï¼š
```bash
# æŸ¥çœ‹å½“å‰å…¬ç½‘IP
curl https://api.ipify.org
```

### 2. APIé¢‘ç‡é™åˆ¶
- å½“å‰ä»£ç è®¾ç½®äº†0.1ç§’å»¶è¿Ÿ
- é¿å…å¹¶å‘è°ƒç”¨
- å¤§æ‰¹é‡å»ºè®®åˆ†æ‰¹å¤„ç†

### 3. æƒé™è¦æ±‚
ç¡®ä¿Secretå¯¹åº”çš„åº”ç”¨æœ‰ä»¥ä¸‹æƒé™ï¼š
- âœ… å®¢æˆ·è”ç³»
- âœ… ç®¡ç†å®¢æˆ·ç¾¤åŠå®¢æˆ·ç¾¤æˆå‘˜

### 4. æ•°æ®ä¿å­˜
- **é€‰é¡¹2**: ä¸è‡ªåŠ¨ä¿å­˜ï¼Œä»…å±•ç¤ºç»“æœ
- **é€‰é¡¹3/4**: è‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [ä¼ä¸šå¾®ä¿¡APIæ–‡æ¡£ - è·å–å®¢æˆ·ç¾¤è¯¦æƒ…](https://developer.work.weixin.qq.com/document/path/92122)
- [ä¼ä¸šå¾®ä¿¡APIé…ç½®è®°å½•](./ä¼ä¸šå¾®ä¿¡APIé…ç½®è®°å½•.md)
- [å¿«é€Ÿä½¿ç”¨æŒ‡å—](./å¿«é€Ÿä½¿ç”¨æŒ‡å—.md)

## ğŸ“ æ•…éšœæ’æŸ¥

### é—®é¢˜1: æç¤º"æ— æ³•è¿æ¥åˆ°æœ¬åœ°API"
**è§£å†³**: å…ˆå¯åŠ¨ `wecom_id_mapper.py` æœåŠ¡

### é—®é¢˜2: æ‰€æœ‰ç¾¤ç»„éƒ½è¿”å›å¤±è´¥
**æ£€æŸ¥**:
1. IPç™½åå•æ˜¯å¦æ­£ç¡®é…ç½®
2. Secretæƒé™æ˜¯å¦è¶³å¤Ÿ
3. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸

### é—®é¢˜3: éƒ¨åˆ†ç¾¤ç»„è·å–å¤±è´¥
**åŸå› **: ç¾¤ç»„å¯èƒ½å·²è§£æ•£æˆ–è¿‡æœŸï¼Œè¿™æ˜¯æ­£å¸¸ç°è±¡

### é—®é¢˜4: è·å–çš„ç¾¤åç§°ä¸ºç©º
**è§£å†³**: æ£€æŸ¥APIè¿”å›çš„ `group_chat.name` å­—æ®µï¼Œå¯èƒ½éœ€è¦ç”¨æˆå‘˜æ•°é‡ä½œä¸ºå¤‡é€‰åç§°

## ğŸ“ˆ åç»­ä¼˜åŒ–å»ºè®®

1. **å¢åŠ é‡è¯•æœºåˆ¶**: å¯¹å¤±è´¥çš„ç¾¤ç»„è‡ªåŠ¨é‡è¯•2-3æ¬¡
2. **å¹¶å‘å¤„ç†**: ä½¿ç”¨çº¿ç¨‹æ± æé«˜å¤„ç†é€Ÿåº¦ï¼ˆæ³¨æ„APIé™åˆ¶ï¼‰
3. **è¿›åº¦ä¿å­˜**: æ”¯æŒä¸­æ–­æ¢å¤ï¼Œé¿å…é‡å¤å¤„ç†
4. **å¯¼å‡ºæŠ¥å‘Š**: ç”Ÿæˆè¯¦ç»†çš„å¤„ç†æŠ¥å‘Šï¼ˆCSV/Excelï¼‰

---

**ç»´æŠ¤äººå‘˜**: è¯·åœ¨ä¿®æ”¹åæ›´æ–°æ­¤æ–‡æ¡£
**æœ€åæ›´æ–°**: 2025-12-31
